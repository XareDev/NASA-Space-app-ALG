<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carina Nebula Viewer | Interactive Astronomical Image Explorer</title>
    <meta name="description" content="Explore the stunning Carina Nebula in high resolution with our interactive OpenSeadragon viewer. Discover celestial wonders with clickable annotations and deep zoom capabilities." />
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(180deg,#0f0f1f 0%,#1a1a35 100%);
            min-height:100vh; color:#e0f7ff; overflow:hidden;
        }
        #viewer { width:100vw; height:100vh; position:absolute; top:0; left:0; background:#0a0a1a; }

        /* starfield */
        .starfield { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; opacity:0.25; z-index:1; }
        .star { position:absolute; width:2px; height:2px; background:#00ffff; border-radius:50%; animation:twinkle 3s infinite; }
        @keyframes twinkle { 0%,100%{opacity:0.25;} 50%{opacity:1;} }

        /* Glass panels */
        .panel {
            background: rgba(10,20,40,0.75);
            backdrop-filter: blur(12px);
            border:1px solid rgba(0,255,255,0.14);
            border-radius:12px;
            padding:16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            z-index:1000;
        }

        /* Info / Help / Debug / Controls */
        #info-panel { position:absolute; top:18px; left:18px; max-width:300px; }
        #info-panel h2 { color:#00ffff; font-size:18px; margin-bottom:10px; display:flex; gap:8px; align-items:center; font-weight:600; }
        .stat { display:flex; justify-content:space-between; margin:6px 0; font-family: 'Courier New', monospace; font-size:13px; }
        .label { color:#b388ff; } .value { color:#e0f7ff; font-weight:600; }

        #help-panel { position:absolute; top:18px; right:18px; max-width:260px; }
        #help-panel h3 { color:#00ffff; font-size:15px; margin-bottom:8px; font-weight:600; }
        .shortcut { display:flex; gap:12px; align-items:center; margin:6px 0; font-size:13px; }
        .key { background:rgba(30,30,60,0.85); border:1px solid rgba(0,170,255,0.25); padding:4px 8px; border-radius:6px; color:#00ffff; font-family:monospace; min-width:28px; text-align:center; }

        #debug-panel { position:absolute; bottom:18px; right:18px; max-width:320px; }
        #debug-content { font-family:'Courier New', monospace; font-size:11px; color:#a0d0e0; white-space:pre-wrap; line-height:1.4; }

        #controls-panel { position:absolute; bottom:18px; left:18px; }
        .controls-grid { display:flex; flex-wrap:wrap; gap:8px; }
        .control-btn {
            background: linear-gradient(to bottom, rgba(30,30,60,0.9), rgba(20,20,50,0.95));
            border:1px solid rgba(0,255,255,0.12);
            padding:8px 12px; border-radius:10px; color:#00ffff; cursor:pointer; font-weight:600;
            display:inline-flex; gap:8px; align-items:center;
        }
        .control-btn:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,255,255,0.06); }

        /* Loading */
        #loading { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#00ffff; font-size:20px; z-index:999; text-align:center; padding:12px 18px; border-radius:10px; background:rgba(4,8,18,0.7); border:1px solid rgba(0,170,255,0.08); }
        .hidden { display:none !important; }

        /* overlays */
        .clickable-overlay { cursor:pointer; transition:transform .12s ease; }
        .clickable-overlay:hover { transform:scale(1.06); filter: drop-shadow(0 0 10px rgba(0,255,255,0.12)); }

        /* Overlay info (modern astro div) */
        #overlay-info-panel {
            position:absolute; bottom:86px; left:18px; width:320px; z-index:1500;
            border-radius:14px; padding:16px;
            background: linear-gradient(180deg, rgba(8,14,28,0.86), rgba(6,8,18,0.85));
            box-shadow: 0 10px 40px rgba(1,6,20,0.8), 0 2px 10px rgba(0,255,255,0.06);
            border:1px solid rgba(0,255,255,0.08);
        }
        #overlay-info-panel h2 { color:#bfefff; font-size:16px; margin-bottom:8px; }
        #overlay-info-panel p { color:#cfe9ef; font-size:14px; line-height:1.45; margin-bottom:12px; }
        .cta-row { display:flex; gap:8px; align-items:center; justify-content:space-between; }
        .cta-btn {
            background: linear-gradient(90deg, rgba(0,255,255,0.9), rgba(179,136,255,0.9));
            border:none; padding:10px 12px; border-radius:8px; font-weight:700; color:#071018; cursor:pointer;
        }
        .close-mini { background:none; border:1px solid rgba(255,255,255,0.04); color:#9fe8ff; padding:6px 8px; border-radius:8px; cursor:pointer; }

        @media (max-width:780px) {
            #overlay-info-panel { left:12px; right:12px; width:auto; bottom:72px; }
            #info-panel, #help-panel, #debug-panel, #controls-panel { max-width:220px; }
        

        body {
            font-size: 14px;
            overflow: hidden;
        }

        /* Panels shrink & move */
        #help-panel, #debug-panel {
            display: none;
        }

        #help-panel {
            display: none;
        }


        #info-panel h2 { font-size: 15px; }
        #help-panel h3 { font-size: 14px; }
        .shortcut { font-size: 12px; }
        .key { padding: 2px 6px; font-size: 11px; }

        /* Controls stack in one column for thumb reach */
        .controls-grid {
            flex-direction: column;
            gap: 6px;
        }
        .control-btn {
            font-size: 13px;
            padding: 8px 10px;
            justify-content: center;
        }

        /* Overlay info panel full-width */
        #overlay-info-panel {
            left: 8px;
            right: 8px;
            width: auto;
            bottom: 60px;
            font-size: 14px;
            padding: 14px;
        }
        #overlay-info-panel h2 { font-size: 15px; }
        #overlay-info-panel p { font-size: 13px; }

        .cta-btn {
            flex: 1;
            text-align: center;
            font-size: 14px;
        }
        .cta-row {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }
        }

    </style>
  </head>

  <body>
    <div class="starfield" id="starfield"></div>
    <div id="loading">Loading nebula image...</div>
    <div id="viewer"></div>

    <!-- Info panel -->
    <div id="info-panel" class="panel">
        <h2>üåå Carina Nebula</h2>
        <div class="stat"><span class="label">Zoom:</span><span class="value" id="zoom-level">1.00x</span></div>
        <div class="stat"><span class="label">Tiles:</span><span class="value" id="tiles-loaded">0</span></div>
        <div class="stat"><span class="label">Rotation:</span><span class="value" id="rotation">0¬∞</span></div>
    </div>

    <!-- Help panel -->
    <div id="help-panel" class="panel">
        <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
        <div class="shortcut"><span class="key">F</span><span>Fullscreen</span></div>
        <div class="shortcut"><span class="key">H</span><span>Home</span></div>
        <div class="shortcut"><span class="key">R</span><span>Rotate 90¬∞</span></div>
        <div class="shortcut"><span class="key">+/-</span><span>Zoom</span></div>
        <div class="shortcut"><span class="key">‚Üê‚Üí‚Üë‚Üì</span><span>Pan</span></div>
    </div>

    <!-- Debug panel -->
    <div id="debug-panel" class="panel">
        <h3>üîç Debug Info</h3>
        <div id="debug-content">Waiting...</div>
    </div>

    <!-- Controls -->
    <div id="controls-panel" class="panel">
        <div class="controls-grid">
            <button class="control-btn" onclick="fitFullImage()">üñº Fit Image</button>
            <button class="control-btn" onclick="viewer.viewport.goHome()">üè† Home</button>
            <button class="control-btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
            <button class="control-btn" onclick="rotateImage()">‚Üª Rotate</button>
            <button class="control-btn" onclick="viewer.viewport.zoomBy(1.5)">Ôºã Zoom In</button>
            <button class="control-btn" onclick="viewer.viewport.zoomBy(0.75)">Ôºç Zoom Out</button>
        </div>
    </div>

    <!-- Modern Astro Overlay Info (hidden by default) -->
    <div id="overlay-info-panel" class="hidden" role="dialog" aria-hidden="true">
        <h2 id="overlay-info-title">Object Title</h2>
        <p id="overlay-info-text">Description goes here. Short and informative ‚Äî what this object is and why it's interesting.</p>
        <div class="cta-row">
            <button id="overlay-cta" class="cta-btn">Learn more</button>
            <button class="close-mini" onclick="closeOverlayInfo()">Close</button>
        </div>
    </div>

    <script>
        // starfield
        const starfield = document.getElementById('starfield');
        for (let i = 0; i < 60; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.top = Math.random() * 100 + '%';
            s.style.left = Math.random() * 100 + '%';
            s.style.animationDelay = Math.random() * 3 + 's';
            s.style.animationDuration = (2 + Math.random() * 3) + 's';
            starfield.appendChild(s);
        }

        // OpenSeadragon viewer
        var viewer = OpenSeadragon({
            id: "viewer",
            prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/images/",
            tileSources: "test.dzi", // update to your .dzi or tileSource object
            mixZoom: false,
            immediateRender: false,
            maxImageCacheCount: 200,
            timeout: 120000,
            useCanvas: true,
            imageLoaderLimit: 6,
            animationTime: 1.0,
            springStiffness: 8.0,
            visibilityRatio: 1.0,
            constrainDuringPan: false,
            wrapHorizontal: false,
            wrapVertical: false,
            minZoomLevel: 0.3,
            maxZoomLevel: 20,
            defaultZoomLevel: 0,
            homeFillsViewer: false,
            zoomPerClick: 1.5,
            zoomPerScroll: 1.3,
            showNavigationControl: true,
            navigationControlAnchor: OpenSeadragon.ControlAnchor.TOP_RIGHT,
            showFullPageControl: false,
            showHomeControl: false,
            showZoomControl: false,
            showRotationControl: true,
            blendTime: 0.3,
            gestureSettingsMouse: { clickToZoom:false, dblClickToZoom:true }
        });

        // keep track whether any tile has drawn (for loading indicator)
        let firstTileDrawn = false;

        // Hide loading when a tile is actually drawn
        viewer.addHandler('tile-drawn', function() {
            if (!firstTileDrawn) {
                firstTileDrawn = true;
                const loading = document.getElementById('loading');
                if (loading) loading.classList.add('hidden');
            }
            // update tiles loaded stat if available
            try {
                const item = viewer.world.getItemAt(0);
                const tiles = (item && item.tilesLoaded) ? item.tilesLoaded : 0;
                document.getElementById('tiles-loaded').textContent = tiles;
            } catch(e){}
        });

        // Update zoom & rotation & debug info
        viewer.addHandler('zoom', function(e) {
            document.getElementById('zoom-level').textContent = e.zoom.toFixed(2) + 'x';
            updateDebugInfo();
        });
        viewer.addHandler('rotate', function() {
            document.getElementById('rotation').textContent = Math.round(viewer.viewport.getRotation()) + '¬∞';
            updateDebugInfo();
        });
        viewer.addHandler('animation', updateDebugInfo);

        function updateDebugInfo() {
            var image = viewer.world.getItemAt(0);
            if (!image) return;
            var bounds = viewer.viewport.getBounds();
            var imageBounds = image.getBounds();
            var center = viewer.viewport.getCenter();
            var imageWidth = image.source && image.source.width ? image.source.width : 'unknown';
            var imageHeight = image.source && image.source.height ? image.source.height : 'unknown';
            var debugHtml =
                `Image: ${imageWidth}x${imageHeight}\n` +
                `Bounds: x=${bounds.x.toFixed(2)}, y=${bounds.y.toFixed(2)}\n` +
                `Size: w=${bounds.width.toFixed(2)}, h=${bounds.height.toFixed(2)}\n` +
                `Image Bounds: w=${imageBounds.width.toFixed(2)}, h=${imageBounds.height.toFixed(2)}\n` +
                `Viewport Center: ${center.x.toFixed(2)}, ${center.y.toFixed(2)}`;
            document.getElementById('debug-content').textContent = debugHtml;
        }

        function fitFullImage() {
            var image = viewer.world.getItemAt(0);
            if (!image) return;
            viewer.viewport.fitBounds(image.getBounds(), true);
        }
        function toggleFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }
        function rotateImage() {
            var currentRotation = viewer.viewport.getRotation();
            viewer.viewport.setRotation(currentRotation + 90);
        }

        // Overlay info panel helpers
        const overlayPanel = document.getElementById('overlay-info-panel');
        const overlayTitle = document.getElementById('overlay-info-title');
        const overlayText = document.getElementById('overlay-info-text');
        const overlayCta = document.getElementById('overlay-cta');

        let currentCtaUrl = null;
        function showOverlayInfo(title, text, ctaUrl) {
            overlayTitle.textContent = title;
            overlayText.textContent = text;
            currentCtaUrl = ctaUrl || null;
            overlayCta.style.display = currentCtaUrl ? 'inline-block' : 'none';
            overlayCta.onclick = function(e) {
                if (currentCtaUrl) window.open(currentCtaUrl, '_blank', 'noopener');
            };
            overlayPanel.classList.remove('hidden');
            overlayPanel.setAttribute('aria-hidden','false');
            // Optionally disable mouse nav while reading
            viewer.setMouseNavEnabled(false);
        }
        function closeOverlayInfo() {
            overlayPanel.classList.add('hidden');
            overlayPanel.setAttribute('aria-hidden','true');
            currentCtaUrl = null;
            viewer.setMouseNavEnabled(true);
        }

        // When viewer opens create overlays and attach MouseTracker AFTER overlays are in DOM
        viewer.addHandler('open', () => {
            // fit image to viewer
            fitFullImage();

            // Create overlays (Eta Carinae and Mystic Mountain), no arrow overlay
            // ETA: adjust locations to match your image coordinates
            const overlays = [
                {
                    id: 'overlay-eta-carinae',
                    point: new OpenSeadragon.Point(0.5, 0.5),
                    innerHTML: `<svg width="64" height="64" viewBox="0 0 64 64" style="overflow:visible;">
                                  <circle cx="32" cy="32" r="26" fill="none" stroke="cyan" stroke-width="2" />
                                  <text x="32" y="58" text-anchor="middle" fill="cyan" font-size="12">Eta Carinae</text>
                                </svg>`,
                    title: 'Eta Carinae',
                    text: 'Eta Carinae is a highly luminous hypergiant star system in the Carina Nebula ‚Äî one of the most massive and luminous systems in our galaxy.',
                    cta: 'https://en.wikipedia.org/wiki/Eta_Carinae'
                },
                {
                    id: 'overlay-mystic-mountain',
                    point: new OpenSeadragon.Point(0.35, 0.4),
                    innerHTML: `<svg width="64" height="64" viewBox="0 0 64 64" style="overflow:visible;">
                                  <circle cx="32" cy="32" r="26" fill="none" stroke="#ff69b4" stroke-width="2" />
                                  <text x="32" y="58" text-anchor="middle" fill="#ff69b4" font-size="12">Mystic Mountain</text>
                                </svg>`,
                    title: 'Mystic Mountain',
                    text: `A pillar of gas and dust within the Carina Nebula, nicknamed 'Mystic Mountain'. This stunning formation is about three light-years tall.`,
                    cta: 'https://www.nasa.gov/image-article/carina-nebula-mystic-mountain/'
                }
            ];

            // Add each overlay to the viewer
            overlays.forEach(o => {
                // remove existing element with same id just in case
                const existing = document.getElementById(o.id);
                if (existing) existing.remove();

                const div = document.createElement('div');
                div.id = o.id;
                div.className = 'clickable-overlay';
                div.style.width = '64px';
                div.style.height = '64px';
                div.style.pointerEvents = 'auto';
                div.innerHTML = o.innerHTML;
                viewer.addOverlay({
                    element: div,
                    location: o.point,
                    placement: OpenSeadragon.Placement.CENTER
                });
            });

            // Attach MouseTracker AFTER overlays are added to DOM
            overlays.forEach(o => {
                const el = document.getElementById(o.id);
                if (!el) return;
                new OpenSeadragon.MouseTracker({
                    element: el,
                    clickHandler: function(event) {
                        // stop propagation so viewer doesn't pan/zoom on click
                        if (event && event.originalEvent) {
                            event.originalEvent.stopPropagation();
                            event.originalEvent.preventDefault();
                        }
                        showOverlayInfo(o.title, o.text, o.cta);
                    },
                    contextMenuHandler: function(event) {
                        // custom right click handling (prevent default menu)
                        if (event && event.originalEvent) {
                            event.originalEvent.preventDefault();
                            event.originalEvent.stopPropagation();
                        }
                        // Show same panel but could be different
                        showOverlayInfo(o.title + ' (right-click)', o.text, o.cta);
                    }
                });
            });

            // if first tiles already drawn previously, hide loading now
            if (viewer.world.getItemAt(0) && !firstTileDrawn) {
                // still wait for tile-drawn event, but as fallback hide after a short timeout
                setTimeout(() => {
                    if (!firstTileDrawn) {
                        const loading = document.getElementById('loading');
                        if (loading) loading.classList.add('hidden');
                        firstTileDrawn = true;
                    }
                }, 1200);
            }
        });

        // Keyboard handlers (restored and robust)
        document.addEventListener('keydown', function(e) {
            const key = e.key;
            const overlayVisible = !overlayPanel.classList.contains('hidden');

            // When overlay open, Escape closes it
            if (overlayVisible && key === 'Escape') {
                closeOverlayInfo();
                return;
            }

            // If overlay visible, still allow some global shortcuts (F/H/R/+/ -)
            // But avoid panning the viewer when typing into inputs (not present here)
            if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) {
                return;
            }

            switch (key) {
                case 'F': case 'f':
                    toggleFullscreen(); break;
                case 'H': case 'h':
                    viewer.viewport.goHome(); break;
                case 'R': case 'r':
                    rotateImage(); break;
                case '+': case '=':
                    viewer.viewport.zoomBy(1.3); break;
                case '-': case '_':
                    viewer.viewport.zoomBy(0.77); break;
                case 'ArrowLeft':
                    viewer.viewport.panBy(new OpenSeadragon.Point(-0.1, 0)); break;
                case 'ArrowRight':
                    viewer.viewport.panBy(new OpenSeadragon.Point(0.1, 0)); break;
                case 'ArrowUp':
                    viewer.viewport.panBy(new OpenSeadragon.Point(0, -0.1)); break;
                case 'ArrowDown':
                    viewer.viewport.panBy(new OpenSeadragon.Point(0, 0.1)); break;
            }
        });

        // hide overlay when clicking outside of it (on document)
        document.addEventListener('click', function(e){
            const overlayVisible = !overlayPanel.classList.contains('hidden');
            if (!overlayVisible) return;
            // If click is inside the panel or on overlay elements, do nothing
            if (overlayPanel.contains(e.target) || e.target.closest('.clickable-overlay')) return;
            // else close
            closeOverlayInfo();
        });

        // Expose a couple functions for UI buttons
        window.fitFullImage = fitFullImage;
        window.toggleFullscreen = toggleFullscreen;
        window.rotateImage = rotateImage;
        window.closeOverlayInfo = closeOverlayInfo;
    </script>
  </body>
</html>
